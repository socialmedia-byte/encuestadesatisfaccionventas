<script>
  // --- refs ---
  const form = document.querySelector('form');
  const steps = [...document.querySelectorAll('.step')];
  const nextBtn = document.getElementById('next');
  const backBtn = document.getElementById('back');
  const submitBtn = document.getElementById('submit');
  const bar = document.getElementById('bar');
  const counter = document.getElementById('counter');

  let idx = 0;
  const total = steps.length;

  // ---- UI ----
  function updateUI(){
    steps.forEach((s,i)=> s.classList.toggle('active', i===idx));
    const pct = ((idx+1) / total) * 100;
    bar.style.width = pct + '%';
    counter.textContent = (idx+1) + ' / ' + total;
    backBtn.disabled = idx===0;
    backBtn.style.opacity = idx===0 ? .5 : 1;
    if(idx === total-1){
      nextBtn.classList.add('hidden');
      submitBtn.classList.remove('hidden');
    }else{
      nextBtn.classList.remove('hidden');
      submitBtn.classList.add('hidden');
    }
    document.querySelector('.card').scrollTo({top:0, behavior:'smooth'});
  }

  function validateStep(i){
    const current = steps[i];
    const requiredFields = current.querySelectorAll('input[required], textarea[required], select[required]');
    for (const el of requiredFields){
      const v = (el.value || '').trim();
      if (!v || (el.minLength && v.length < el.minLength)){
        el.reportValidity ? el.reportValidity() : alert('Completa este paso antes de continuar.');
        el.focus();
        return false;
      }
    }
    return true;
  }

  function validateAll(){
    // Valida TODOS los pasos por si alguien saltó con inspector/teclas
    for (let i=0; i<steps.length; i++){
      const requiredFields = steps[i].querySelectorAll('input[required], textarea[required], select[required]');
      for (const el of requiredFields){
        const v = (el.value || '').trim();
        if (!v || (el.minLength && v.length < el.minLength)){
          // salta visualmente al paso con error
          idx = i;
          updateUI();
          el.reportValidity ? el.reportValidity() : alert('Faltan respuestas obligatorias.');
          el.focus();
          return false;
        }
      }
    }
    return true;
  }

  nextBtn.addEventListener('click', ()=>{
    if (idx < total-1){
      if(!validateStep(idx)) return;
      idx++; updateUI();
    }
  });

  backBtn.addEventListener('click', ()=>{
    if (idx > 0){ idx--; updateUI(); }
  });

  // Chips UX (checkbox/radio)
  const chips = document.querySelectorAll('.chip');
  chips.forEach(chip=>{
    chip.addEventListener('click', (e)=>{
      const input = chip.querySelector('input');
      if(!input) return;
      if(input.type === 'checkbox'){
        input.checked = !input.checked;
        chip.classList.toggle('active', input.checked);
      }else if(input.type === 'radio'){
        const group = input.name;
        document.querySelectorAll(`input[name="${group}"]`).forEach(r=>{
          r.closest('.chip')?.classList.remove('active');
        });
        input.checked = true;
        chip.classList.add('active');
      }
      e.preventDefault();
    });
  });

  // Evita avanzar con Enter sin validar
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && idx < total-1){
      e.preventDefault();
      nextBtn.click();
    }
  });

  // ---------- ENVÍO A PRUEBA DE BALAS ----------
  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); // manejamos el envío nosotros
    if(!validateAll()) return;

    // estado UI
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando…';
    nextBtn.disabled = true;
    backBtn.disabled = true;

    // agrega un ID único por envío (útil si quieres deduplicar después)
    const submissionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    let hiddenId = form.querySelector('input[name="submission_id"]');
    if(!hiddenId){
      hiddenId = document.createElement('input');
      hiddenId.type = 'hidden';
      hiddenId.name = 'submission_id';
      form.appendChild(hiddenId);
    }
    hiddenId.value = submissionId;

    const fd = new FormData(form);

    let sent = false;

    // 1) intento principal: fetch CORS normal
    try{
      const res = await fetch(form.action, {
        method: 'POST',
        body: fd,
        headers: { 'Accept': 'application/json' },
        // no 'mode:no-cors' para poder detectar errores
      });
      if(res.ok){
        sent = true;
      }
    }catch(_){ /* ignore */ }

    // 2) fallback: sendBeacon (fire-and-forget). No sabemos el resultado, pero dispara el POST.
    if(!sent && navigator.sendBeacon){
      try{
        // Convierte FormData a URLSearchParams para beacon
        const usp = new URLSearchParams();
        for (const [k,v] of fd.entries()){ usp.append(k, v); }
        const blob = new Blob([usp.toString()], { type: 'application/x-www-form-urlencoded;charset=UTF-8' });
        const ok = navigator.sendBeacon(form.action, blob);
        if(ok) sent = true;
      }catch(_){ /* ignore */ }
    }

    // 3) último recurso: submit tradicional en iframe oculto (no interrumpe la UI)
    if(!sent){
      try{
        const iframe = document.createElement('iframe');
        iframe.name = 'hidden_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        const originalTarget = form.target;
        form.target = 'hidden_iframe';

        // Clona y envía mediante un form temporal para no perder estado
        const tempForm = document.createElement('form');
        tempForm.method = 'POST';
        tempForm.action = form.action;
        tempForm.target = 'hidden_iframe';
        tempForm.style.display = 'none';

        for (const [k,v] of fd.entries()){
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = k;
          input.value = v;
          tempForm.appendChild(input);
        }
        document.body.appendChild(tempForm);
        tempForm.submit();

        // si llegamos aquí, consideramos enviado
        sent = true;

        // limpia
        setTimeout(()=>{
          form.target = originalTarget || '';
          tempForm.remove();
          iframe.remove();
        }, 4000);
      }catch(_){ /* ignore */ }
    }

    if(sent){
      // Pantalla de éxito (sin tocar tu copy de “Gracias” por si quieres mantener el paso 8)
      // Avanza a la última pantalla si no está ya ahí
      if(idx < total-1){ idx = total-1; updateUI(); }
      submitBtn.textContent = 'Enviado ✓';
      // opcional: reset después de unos segundos
      // setTimeout(()=> form.reset(), 6000);
    }else{
      alert('No se pudo enviar. Revisa tu conexión e inténtalo nuevamente.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar respuestas';
      nextBtn.disabled = false;
      backBtn.disabled = false;
    }
  });

  // Init
  updateUI();
</script>


